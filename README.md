![troobleshooting](https://github.com/gaming4funNel/db-06-troobleshooting/blob/main/img/troobleshooting1.png)

# Домашнее задание к занятию 6. «Troubleshooting»

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;

Войду в MongoDB shell и выполню команду db.currentOp() для получения списка текущих операций.
Выясню, какая из операций соответствует запросу пользователя. Пойму ее ID.
Далее, прерву операцию используя команду db.killOp(<ID>).

- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

Включить MongoDB Profiler для мониторинга и профилирования запросов. Это позволит идентифицировать медленные операции. Можно использовать db.setProfilingLevel(1, 100) для включения профилирования на уровне 1 и установки уровня медленных запросов.

Необходимо убедиться, что все поля, используемые в запросах, имеют соответствующие индексы. Индексирование может существенно ускорить поиск данных. db.collection.createIndex() для создания новых индексов.

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

Ситуация, в которой отношение количества записанных key-value-значений к количеству истёкших значений увеличивается при масштабировании сервиса, а Redis блокирует операции записи, может быть связана с проблемами в механизме управления памятью и стратегии вытеснения данных в Redis.

При увеличении количества реплик сервиса увеличивается общее количество данных, которые нужно хранить в Redis.
Возможно, Redis достигает лимита по доступной памяти, что приводит к блокировке операций записи.
Решение: Необходимо проверить доступное пространство для Redis и увеличьте объем выделенной памяти, если это необходимо.

Механизм TTL в Redis удаляет устаревшие ключи автоматически. Если отношение записанных к истекшим значениям растет, это может быть связано с неэффективной стратегией вытеснения данных.
Решение: Возможно, стоит пересмотреть политику вытеснения данных в пользу более подходящей стратегии. Нужно проверить конфигурацию Redis, особенно параметры, связанные с памятью, TTL и вытеснением данных. 
 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

Ошибка "Lost connection to MySQL server during query" указывает на то, что соединение с сервером MySQL было потеряно во время выполнения запроса. 

Проблемы с сетью. Необходимо проверить состояние сетевого подключения между приложением и сервером базы данных. Может быть, есть временные проблемы с сетью, такие как потери пакетов или низкая пропускная способность.

Настройки тайм-аута. Нужно проверить, что настройки тайм-аута в вашей базе данных и в приложении адекватно настроены. Возможно, запросы занимают слишком много времени, и соединение закрывается из-за превышения времени ожидания.

Недостаток ресурсов сервера. Проанализировать использование ресурсов на сервере MySQL. Если он испытывает недостаток памяти, CPU или других ресурсов, это может привести к потере соединения.

Оптимизация запросов. Возможно, есть неэффективные или долгосрочные запросы, которые следует оптимизировать.

## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?

Сообщение "oom-killer" в dmesg указывает на то, что в ядре операционной системы был запущен механизм убийства процессов (OOM-killer), потому что было исчерпано доступное пространство оперативной памяти, и ядро решило завершить какие-то процессы для освобождения памяти. Это может происходить, когда PostgreSQL потребляет слишком много памяти и приводит к исчерпанию ресурсов системы.

Проверка настройки памяти в файле конфигурации PostgreSQL postgresql.conf. Параметры shared_buffers, work_mem, и maintenance_work_mem.

Увеличение объема оперативной памяти.

Ограничение использования памяти. В файле конфигурации PostgreSQL можно установить параметр max_connections на разумное значение и рассмотреть возможность использования max_wal_size и min_wal_size для управления использованием памяти журнала транзакций.

---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---

